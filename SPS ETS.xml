<?xml version="1.0" encoding="utf-8"?>
<ctl:package 
    xmlns:ctl="http://www.occamlab.com/ctl" 
    xmlns:ocp="http://www.occamlab.com/te/parsers" 
    xmlns:tep="http://teamengine.sourceforge.net/parsers" 
    xmlns:saxon="http://saxon.sf.net/" 
    xmlns:xi="http://www.w3.org/2001/XInclude" 
    xmlns:xlink="http://www.w3.org/1999/xlink" 
    xmlns:xsd="http://www.w3.org/2001/XMLSchema" 
    xmlns:sps="http://www.opengis.net/sps" 
    xmlns:ows="http://www.opengis.net/ows"
    xmlns:sml="http://www.opengis.net/sensorML" 
    xmlns:tml="http://www.opengis.net/tml" 
    xmlns:gml="http://www.opengis.net/gml" 
    xmlns="http://www.w3.org/1999/xhtml" 
    xmlns:db5="http://docbook.org/ns/docbook" 
    xmlns:parsers="http://www.occamlab.com/te/parsers" 
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:spsFunctions="https://cite.opengeospatial.org/sps-1.0/src/ctl/functions.xml"
    xmlns:swe="http://www.opengis.net/swe"
    xmlns:xml="http://www.w3.org/XML/1998/namespace">
    
  <!--<xi:include href="functions.xml"/>-->
  
  <ctl:suite name="sps:suite">
    <!--NOTE: Don't forget to update the TARGET_NAMESPACE_URI and ATS_URL placeholder values-->
    <ctl:title>Annex A - Abstract Test Suite for SPS 1.0</ctl:title>
    <ctl:starting-test>sps:Main</ctl:starting-test>
  </ctl:suite>
  <ctl:test name="sps:Main">
    <ctl:assertion>The IUT satisfies all applicable assertions.</ctl:assertion>
    <ctl:code>
      <!--
                1.)  Prompt the user to provide the url for an SPS implementation.
                2.)  Send a request to the provided url to determine if there is a response
                3.)  If there is a response, then begin executing tests, else fail.
            -->
        <xsl:variable name="form-values">
            <ctl:form height="640" width="800">
               <body>
                  <h2>Compliance test suite for Sensor Planning Service (SPS) 1.0</h2>
                  <h3>Service metadata</h3>
                  <p>
                  Please provide a URL from which a capabilities document can 
                  be retrieved. Modify the URL template below to specify the 
                  location of an OGC SPS implementation 
                  under test.
                  </p>
                  <blockquote>
                     <table border="1" padding="4" bgcolor="#00ffff">
                        <tr>
                           <td align="left">Service URL:</td>                        
                           <td align="center">
                              <input name="service-url" size="128" 
                              type="text" 
                              value="http://hostname:port/path"/>
                           </td>
                        </tr>
                     </table>
                  </blockquote>
                  <input type="submit" value="Start"/>
               </body>
            </ctl:form>
         </xsl:variable>

		<!-- Get user input:  Get the value of the SPS URL that the user supplies -->
		<xsl:variable name="sps.service.get.url" select="$form-values/values/value[@key='service-url']"/>
        
        <!--Call each test passing the capabilities URL as the parameter-->
        <ctl:call-test name="sps:ows-main">
            <ctl:with-param name="serviceURL" select="$sps.service.get.url" />
        </ctl:call-test>
        <ctl:call-test name="sps:general-main">
            <ctl:with-param name="serviceURL" select="$sps.service.get.url" />
        </ctl:call-test>
        <ctl:call-test name="sps:core-main">
            <ctl:with-param name="serviceURL" select="$sps.service.get.url" />
        </ctl:call-test>
    </ctl:code>
  </ctl:test>
  <ctl:package>
    <ctl:test name="sps:ows-main">
      <ctl:param name="serviceURL" />
      <ctl:assertion>All assertions for "ows" conformance are satisfied.</ctl:assertion>
      <ctl:comment>Test driver for the ows module.</ctl:comment>
      <ctl:link title="1. OWS">ATS_URL#ows</ctl:link>
      <ctl:code>
        <ctl:call-test name="sps:ows-OWS.ClientError.1">
          <ctl:with-param name="test.document" select="$serviceURL" />
        </ctl:call-test>
        <ctl:call-test name="sps:ows-OWS.ContentType.1">
          <ctl:with-param name="test.document" select="$serviceURL" />
        </ctl:call-test>
        <ctl:call-test name="sps:ows-OWS.CaseInsensitiveKvpNames.1">
          <ctl:with-param name="test.document" select="$serviceURL" />
        </ctl:call-test>
        <ctl:call-test name="sps:ows-OWS.GetCapabilities.1">
          <ctl:with-param name="test.document" select="$serviceURL" />
        </ctl:call-test>
        <ctl:call-test name="sps:ows-OWS.GetCapabilities-Exceptions.1">
          <ctl:with-param name="test.document" select="$serviceURL" />
        </ctl:call-test>
        <ctl:call-test name="sps:ows-OWS.GetCapabilities-AcceptVersions.1">
          <ctl:with-param name="test.document" select="$serviceURL" />
        </ctl:call-test>
        <ctl:call-test name="sps:ows-OWS.GetCapabilities-Sections.1">
          <ctl:with-param name="test.document" select="$serviceURL" />
        </ctl:call-test>
        <ctl:call-test name="sps:ows-OWS.GetCapabilities-AcceptFormats.1">
          <ctl:with-param name="test.document" select="$serviceURL" />
        </ctl:call-test>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:ows-OWS.ClientError.1">
      <ctl:param name="test.document" />
      <ctl:assertion>Test purpose</ctl:assertion>
      <ctl:comment>Test method</ctl:comment>
      <ctl:link title="Client error">ATS_URL#OWS.ClientError</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:ows-OWS.ContentType.1">
      <ctl:param name="test.document" />
      <ctl:assertion>Test purpose</ctl:assertion>
      <ctl:comment>Test method</ctl:comment>
      <ctl:link title="Content-Type response header">ATS_URL#OWS.ContentType</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:ows-OWS.CaseInsensitiveKvpNames.1">
      <ctl:param name="test.document" />
      <ctl:assertion>Test purpose</ctl:assertion>
      <ctl:comment>Test method</ctl:comment>
      <ctl:link title="KVP parameter names">ATS_URL#OWS.CaseInsensitiveKvpNames</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:ows-OWS.GetCapabilities.1">
      <ctl:param name="test.document" />
      <ctl:assertion>Test purpose</ctl:assertion>
      <ctl:comment>Test method</ctl:comment>
      <ctl:link title="GetCapabilities request">ATS_URL#OWS.GetCapabilities</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:ows-OWS.GetCapabilities-Exceptions.1">
      <ctl:param name="test.document" />
      <ctl:assertion>Test purpose</ctl:assertion>
      <ctl:comment>Test method</ctl:comment>
      <ctl:link title="GetCapabilities - Exceptions">ATS_URL#OWS.GetCapabilities-Exceptions</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:ows-OWS.GetCapabilities-AcceptVersions.1">
      <ctl:param name="test.document" />
      <ctl:assertion>Test purpose</ctl:assertion>
      <ctl:comment>Test method</ctl:comment>
      <ctl:link title="GetCapabilities - AcceptVersions parameter">ATS_URL#OWS.GetCapabilities-AcceptVersions</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:ows-OWS.GetCapabilities-Sections.1">
      <ctl:param name="test.document" />
      <ctl:assertion>Test purpose</ctl:assertion>
      <ctl:comment>Test method</ctl:comment>
      <ctl:link title="GetCapabilities - Sections parameter">ATS_URL#OWS.GetCapabilities-Sections</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:ows-OWS.GetCapabilities-AcceptFormats.1">
      <ctl:param name="test.document" />
      <ctl:assertion>Test purpose</ctl:assertion>
      <ctl:comment>Test method</ctl:comment>
      <ctl:link title="GetCapabilities - AcceptFormats parameter">ATS_URL#OWS.GetCapabilities-AcceptFormats</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
      </ctl:code>
    </ctl:test>
  </ctl:package>
  <ctl:package>
    <ctl:test name="sps:general-main">
      <ctl:param name="serviceURL" />
      <ctl:assertion>All assertions for "general" conformance are satisfied.</ctl:assertion>
      <ctl:comment>Test driver for the general module.</ctl:comment>
      <ctl:link title="2. General">ATS_URL#general</ctl:link>
      <ctl:code>
        <ctl:call-test name="sps:general-SPS.General-InvalidRequest.1">
          <ctl:with-param name="serviceURL" select="$serviceURL" />
        </ctl:call-test>
        <!--<ctl:call-test name="sps:general-SPS.General-ValidResponse.1">
                        <ctl:with-param name="serviceURL" select="$serviceURL" />
                    </ctl:call-test>-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:general-SPS.General-InvalidRequest.1">
      <ctl:param name="serviceURL" />
      <ctl:assertion>Test purpose</ctl:assertion>
      <ctl:comment>Test method</ctl:comment>
      <ctl:link title="Verify that an invalid request produces an appropriate response from the server.">ATS_URL#SPS.General-InvalidRequest</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.)  Issue several invalid request documents to the service.
                    2.)  Validate the response against the ExceptionReport schema.
                    3.)  If the response validates, then check that the exceptionCode value is "InvalidRequest"
                -->
        <ctl:message>Issuing an invalid request to:  <xsl:value-of select="$serviceURL" /></ctl:message>
        <xsl:variable name="invalidRequestResponse">
            <ctl:call-function name="spsFunctions:invalidRequest">
                <ctl:with-param name="methodURL" select="$serviceURL" />
                <ctl:with-param name="postBody">
                    Test
                </ctl:with-param>
            </ctl:call-function>
        </xsl:variable>
        <xsl:choose>
            <xsl:when test="not($invalidRequestResponse/*)">
                <ctl:message>The server did not return a response to an invalid request or the response from the server was not a valid exception report.  The response from the server was:  "<xsl:value-of select="$invalidRequestResponse/*" />"</ctl:message>
                <ctl:fail />
            </xsl:when>
            <xsl:otherwise>
                <xsl:variable name="isCorrect">
                    <ctl:call-function name="spsFunctions:checkExceptionReport">
                        <ctl:with-param name="exceptionReport" select="$invalidRequestResponse/*" />
                        <ctl:with-param name="exceptionCodeToCheck" select="string('InvalidRequest')" />
                        <ctl:with-param name="locatorToCheck" select="string('*')" />
                    </ctl:call-function>
                </xsl:variable>
                <xsl:if test="not(isCorrect)">
                    <ctl:message>The response to an invalid request was expected to be an exception report with an exceptionCode of "InvalidRequest" and a locator value containing the validation issue.  The returned exception report was:  "<xsl:value-of select="$invalidRequestResponse/*" />"</ctl:message>
                    <ctl:fail />
                </xsl:if>
            </xsl:otherwise>
        </xsl:choose>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:general-SPS.General-ValidResponse.1">
      <ctl:param name="responseDocument" />
      <ctl:assertion>A response is a valid response for the SPS</ctl:assertion>
      <ctl:comment>Test method</ctl:comment>
      <ctl:link title="Verify that a response entity is schema-valid">ATS_URL#SPS.General-ValidResponse</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.) Validate response according to its associated schema.  This includes if the response is an ExceptionReport.
                -->
        <xsl:variable name="validationResponse">
            <ctl:call-function name="spsFunctions:validateResponse">
                <ctl:with-param name="responseDocument" select="$responseDocument" />
            </ctl:call-function>
        </xsl:variable>
        <xsl:if test="not($validationResponse/*)">
            <ctl:message>The response was not a valid response for the SPS.</ctl:message>
            <ctl:fail />
        </xsl:if>
      </ctl:code>
    </ctl:test>
  </ctl:package>
  <ctl:package>
    <ctl:test name="sps:core-main">
      <ctl:param name="serviceURL" />
      <ctl:assertion>All assertions for "core" conformance are satisfied.</ctl:assertion>
      <ctl:comment>Test driver for the core module.</ctl:comment>
      <ctl:link title="3. Core">ATS_URL#core</ctl:link>
      <ctl:code>
        <ctl:call-test name="sps:core-SPS.GetCapabilities-KVPRequestParameterHandling.1">
          <ctl:with-param name="serviceURL" select="$serviceURL" />
        </ctl:call-test>
        <ctl:call-test name="sps:core-SPS.GetCapabilities-KVPRequestServiceParameterHandling.1">
          <ctl:with-param name="serviceURL" select="$serviceURL" />
        </ctl:call-test>
        <ctl:call-test name="sps:core-SPS.GetCapabilities-KVPRequestRequestParameterHandling.1">
          <ctl:with-param name="serviceURL" select="$serviceURL" />
        </ctl:call-test>
        <xsl:variable name="getCapabilitiesResponse">
            <ctl:call-test name="sps:core-SPS.GetCapabilities-ResponseMain.1">
                <ctl:with-param name="serviceURL" select="$serviceURL" />
            </ctl:call-test>
        </xsl:variable>
        
        <!--If there was a response to a valid GetCapabilities request and the response is valid, then continue the tests-->
        <xsl:if test="$getCapabilitiesResponse/*">
        
            <!--Get the DescribeTasking URL-->
            <xsl:variable name="describeTaskingElement" select="$getCapabilitiesResponse//ows:OperationsMetadata/ows:Operation[@name='DescribeTasking']" />
            <!---->
            <xsl:if test="$describeTaskingElement">
                <xsl:variable name="describeTaskingURL" select="$describeTaskingElement/ows:DCP/ows:HTTP/ows:Post/@xlink:href" />
                <ctl:call-test name="sps:core-SPS.DescribeTasking-RequestInvalidSensorIDs.1">
                    <ctl:with-param name="describeTaskingURL" select="$describeTaskingURL" />
                </ctl:call-test>
                <ctl:call-test name="sps:core-SPS.DescribeTasking-RequestNullSensorID.1">
                  <ctl:with-param name="describeTaskingURL" select="$describeTaskingURL" />
                </ctl:call-test>
                <ctl:call-test name="sps:core-SPS.DescribeTasking-ResponseMain.1">
                    <ctl:with-param name="describeTaskingURL" select="$describeTaskingURL" />
                    <ctl:with-param name="getCapabilitiesResponse" select="$getCapabilitiesResponse" />
                </ctl:call-test>
                <!--
                                <ctl:call-test name="sps:core-SPS.DescribeTasking-ResponseMatchingSensorIDs.1">
                                  <ctl:with-param name="describeTaskingURL" select="$describeTaskingURL" />
                                </ctl:call-test>
                                <ctl:call-test name="sps:core-SPS.DescribeTasking-ResponseValidInputDescriptor.1">
                                  <ctl:with-param name="describeTaskingURL" select="$describeTaskingURL" />
                                </ctl:call-test>
                                <ctl:call-test name="sps:core-SPS.DescribeTasking-ResponseValidInputDescriptorParameterID.1">
                                  <ctl:with-param name="describeTaskingURL" select="$describeTaskingURL" />
                                </ctl:call-test>
                                <ctl:call-test name="sps:core-SPS.DescribeTasking-ValidException.1">
                                  <ctl:with-param name="describeTaskingURL" select="$describeTaskingURL" />
                                </ctl:call-test>
                                -->
            </xsl:if>
            
            <!--Get the Submit URL-->
            <xsl:variable name="submitElement" select="$getCapabilitiesResponse//ows:OperationsMetadata/ows:Operation[@name='Submit']" />
            <!---->
            <xsl:if test="$submitElement">
                <xsl:variable name="submitURL" select="$submitElement/ows:DCP/ows:HTTP/ows:Post/@xlink:href" />
                <ctl:call-test name="sps:core-SPS.Submit-RequestMain.1">
                    <ctl:with-param name="submitURL" select="$submitURL" />
                </ctl:call-test>
                
                <!--
                                <ctl:call-test name="sps:core-SPS.Submit-ResponseValidTaskID.1">
                                  <ctl:with-param name="submitURL" select="$submitURL" />
                                </ctl:call-test>
                                <ctl:call-test name="sps:core-SPS.Submit-ResponseValidEstimatedToC.1">
                                  <ctl:with-param name="submitURL" select="$submitURL" />
                                </ctl:call-test>
                                <ctl:call-test name="sps:core-SPS.Submit-ResponseCorrectUseOfAlternative.1">
                                  <ctl:with-param name="submitURL" select="$submitURL" />
                                </ctl:call-test>
                                <ctl:call-test name="sps:core-SPS.Submit-ResponseValidLatestResponseTime.1">
                                  <ctl:with-param name="submitURL" select="$submitURL" />
                                </ctl:call-test>
                                <ctl:call-test name="sps:core-SPS.Submit-ValidException.1">
                                  <ctl:with-param name="submitURL" select="$submitURL" />
                                </ctl:call-test>
                                -->
            </xsl:if>
            
            <!--Get the DescribeResultAccess URL-->
            <xsl:variable name="describeResultAccessElement" select="$getCapabilitiesResponse//ows:OperationsMetadata/ows:Operation[@name='DescribeResultAccess']" />
            <!---->            
            <xsl:if test="$describeResultAccessElement">
                <xsl:variable name="describeResultAccessURL" select="$describeResultAccessElement/ows:DCP/ows:HTTP/ows:Post/@xlink:href" />
                <ctl:call-test name="sps:core-SPS.DescribeResultAccess-RequestNullSensorID.1">
                    <ctl:with-param name="describeResultAccessURL" select="$describeResultAccessURL" />
                </ctl:call-test>
                <ctl:call-test name="sps:core-SPS.DescribeResultAccess-RequestInvalidSensorID.1">
                  <ctl:with-param name="describeResultAccessURL" select="$describeResultAccessURL" />
                </ctl:call-test>
                <ctl:call-test name="sps:core-SPS.DescribeResultAccess-RequestNullTaskID.1">
                  <ctl:with-param name="describeResultAccessURL" select="$describeResultAccessURL" />
                </ctl:call-test>
                <ctl:call-test name="sps:core-SPS.DescribeResultAccess-RequestInvalidTaskID.1">
                  <ctl:with-param name="describeResultAccessURL" select="$describeResultAccessURL" />
                </ctl:call-test>
                <ctl:call-test name="sps:core-SPS.DescribeResultAccess-ResponseMain.1">
                    <ctl:with-param name="describeResultAccessURL" select="$describeResultAccessURL" />
                    <ctl:with-param name="getCapabilitiesResponse" select="$getCapabilitiesResponse" />
                </ctl:call-test>
                <!--
                                <ctl:call-test name="sps:core-SPS.DescribeResultAccess-ResponseSensorIDValidResponse.1">
                                  <ctl:with-param name="test.document" select="$test.document" />
                                </ctl:call-test>
                                <ctl:call-test name="sps:core-SPS.DescribeResultAccess-ResponseValidServiceType.1">
                                  <ctl:with-param name="test.document" select="$test.document" />
                                </ctl:call-test>
                                <ctl:call-test name="sps:core-SPS.DescribeResultAccess-ResponseValidServiceURL.1">
                                  <ctl:with-param name="test.document" select="$test.document" />
                                </ctl:call-test>
                                <ctl:call-test name="sps:core-SPS.DescribeResultAccess-ResponseValidDataNotAvailable.1">
                                  <ctl:with-param name="test.document" select="$test.document" />
                                </ctl:call-test>
                                <ctl:call-test name="sps:core-SPS.DescribeResultAccess-ValidException.1">
                                  <ctl:with-param name="test.document" select="$test.document" />
                                </ctl:call-test>
                                -->
            </xsl:if>
            
            <!--<ctl:call-test name="sps:core-SPS.GetCapabilities-ResponseOperationMetadataMandatoryOperations.1">
                                <ctl:with-param name="serviceURL" select="$serviceURL" />
                            </ctl:call-test>
                            <ctl:call-test name="sps:core-SPS.GetCapabilities-ResponseOperationMetadataOptionalOperations.1">
                                <ctl:with-param name="test.document" select="$serviceURL" />
                            </ctl:call-test>
                            <ctl:call-test name="sps:core-SPS.GetCapabilities-ResponseContentsSensorOfferings.1">
                                <ctl:with-param name="test.document" select="$serviceURL" />
                            </ctl:call-test>
                            <ctl:call-test name="sps:core-SPS.GetCapabilities-ResponseContentsSensorOfferingsValidSensorDefinition.1">
                                <ctl:with-param name="test.document" select="$serviceURL" />
                            </ctl:call-test>
                            <ctl:call-test name="sps:core-SPS.GetCapabilities-ResponseContentsPhenomenonOfferings.1">
                                <ctl:with-param name="test.document" select="$test.document" />
                            </ctl:call-test>-->
                     
        </xsl:if>
      </ctl:code>
    </ctl:test>
    <!--GetCapabilities tests-->
    <ctl:test name="sps:core-SPS.GetCapabilities-KVPRequestParameterHandling.1">
      <ctl:param name="serviceURL" />
      <ctl:assertion>The server returns a valid error report message with an exception code of MissingParameterValue when mandatory parameters are missing from the request.</ctl:assertion>
      <ctl:comment>Pass if the exception report is valid and the exceptionCode parameter contains MissingParameterValue; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the server handles missing parameters correctly.">ATS_URL#SPS.GetCapabilities-KVPRequestParameterHandling</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.)  HTTP GET request missing the service and request parameters
                    2.)  HTTP GET request missing the service parameter
                    3.)  HTTP GET request missing the request parameter
                -->
        <!--GetCapabilities request with no service and no request parameter-->
        <ctl:message>Issuing a GetCapabilities request with no service parameter and no request parameter provided.</ctl:message>
        <xsl:variable name="requestNoServiceNoRequest">
            <ctl:request>
                <ctl:url>
                    <xsl:value-of select="$serviceURL" />
                </ctl:url>
                <ctl:method>get</ctl:method>
                <!--Parser to get response-->
                <!--<parsers:XMLValidatingParser>
                    <parsers:schemas>
                        <parsers:schema type="url">
                            <ctl:call-function name="spsFunctions:getSchemaLocation">
                                <ctl:with-param name="schemaName" select="string('owsExceptionReport.xsd')" />
                            </ctl:call-function>
                        </parsers:schema>
                    </parsers:schemas>
                </parsers:XMLValidatingParser>-->
                <!--<ctl:call-test name="sps:general-SPS.General-ValidResponse.1">
                                    <ctl:with-param name="responseDocument" select="$response//content/*" />
                                    </ctl:call-test>-->
            </ctl:request>
        </xsl:variable>
        <ctl:message>The server returned the following response:  <xsl:value-of select="$requestNoServiceNoRequest/*" /></ctl:message>
        <ctl:message>Issuing a GetCapabilities request with no service parameter provided.</ctl:message>
        <!--GetCapabilities request with no service parameter-->
        <xsl:variable name="requestNoService">
            <ctl:request>
                <ctl:url>
                    <xsl:value-of select="$serviceURL" />
                </ctl:url>
                <ctl:method>get</ctl:method>
                <ctl:param name="request">GetCapabilities</ctl:param>
                <!--Parser to get response-->
                <!--<parsers:XMLValidatingParser>
                    <parsers:schemas>
                        <parsers:schema type="url">
                            <ctl:call-function name="spsFunctions:getSchemaLocation">
                                <ctl:with-param name="schemaName" select="string('owsExceptionReport.xsd')" />
                            </ctl:call-function>
                        </parsers:schema>
                    </parsers:schemas>
                </parsers:XMLValidatingParser>-->
                <!--<ctl:call-test name="sps:general-SPS.General-ValidResponse.1">
                                    <ctl:with-param name="responseDocument" select="$response//content/*" />
                                    </ctl:call-test>-->
            </ctl:request>
        </xsl:variable>
        <ctl:message>The server returned the following response:  <xsl:value-of select="$requestNoService/*" /></ctl:message>
        <ctl:message>Issuing a GetCapabilities request with no request parameter provided.</ctl:message>
        <!--GetCapabilities request with no request parameter-->
        <xsl:variable name="requestNoRequest">
            <ctl:request>
                <ctl:url>
                    <xsl:value-of select="$serviceURL" />
                </ctl:url>
                <ctl:method>get</ctl:method>
                <ctl:param name="service">SPS</ctl:param>
                <!--Parser to get response-->
                <!--<parsers:XMLValidatingParser>
                    <parsers:schemas>
                        <parsers:schema type="url">
                            <ctl:call-function name="spsFunctions:getSchemaLocation">
                                <ctl:with-param name="schemaName" select="string('owsExceptionReport.xsd')" />
                            </ctl:call-function>
                        </parsers:schema>
                    </parsers:schemas>
                </parsers:XMLValidatingParser>-->
                <!--<ctl:call-test name="sps:general-SPS.General-ValidResponse.1">
                                    <ctl:with-param name="responseDocument" select="$response//content/*" />
                                    </ctl:call-test>-->
            </ctl:request>
        </xsl:variable>
        <!--Check the responses to each of the above requests to ensure that they are valid-->
        <ctl:message>The server returned the following response:  <xsl:value-of select="$requestNoRequest/*" /></ctl:message>
        <xsl:choose>
            <xsl:when test="not($requestNoServiceNoRequest/*) or not($requestNoService/*) or not($requestNoRequest/*)">
                <ctl:message>The server did not return a response or the response was not a valid exception.</ctl:message>
                <ctl:fail />
            </xsl:when>
            <xsl:otherwise>
                <xsl:if test="$requestNoServiceNoRequest/*">
                    <ctl:message>Checking the validity of the response to a GetCapabilities request with no service and no request parameters.</ctl:message>
                    <xsl:variable name="isCorrect">
                        <ctl:call-function name="spsFunctions:checkExceptionReport">
                            <ctl:with-param name="exceptionReport" select="$requestNoServiceNoRequest/*" />
                            <ctl:with-param name="exceptionCodeToCheck" select="string('MissingParameterValue')" />
                            <ctl:with-param name="locatorToCheck" select="string('REQUEST,SERVICE')" />
                        </ctl:call-function>
                    </xsl:variable>
                    <ctl:message>The validity check returned:  <xsl:value-of select="$isCorrect" /></ctl:message>
                    <xsl:if test="not(boolean($isCorrect))">
                        <ctl:message>The server did not return the expected exception report response to a GetCapabilities request with no request and no service parameters specified.  "<xsl:value-of select="$requestNoServiceNoRequest" />" was returned instead.</ctl:message>
                        <ctl:fail />
                    </xsl:if>
                </xsl:if>
                <xsl:if test="$requestNoService/*">
                    <ctl:message>Checking the validity of the response to a GetCapabilities request with no service parameter.</ctl:message>
                    <xsl:variable name="isCorrect">
                        <ctl:call-function name="spsFunctions:checkExceptionReport">
                            <ctl:with-param name="exceptionReport" select="$requestNoService/*" />
                            <ctl:with-param name="exceptionCodeToCheck" select="string('MissingParameterValue')" />
                            <ctl:with-param name="locatorToCheck" select="string('Service')" />
                        </ctl:call-function>
                    </xsl:variable>
                    <ctl:message>The validity check returned:  <xsl:value-of select="$isCorrect" /></ctl:message>
                    <xsl:if test="not(boolean($isCorrect))">
                        <ctl:message>The server did not return the expected exception report response to a GetCapabilities request with no service parameter specified.  "<xsl:value-of select="$requestNoService" />" was returned instead.</ctl:message>
                        <ctl:fail />
                    </xsl:if>
                </xsl:if>
                <xsl:if test="$requestNoRequest/*">
                    <ctl:message>Checking the validity of the response to a GetCapabilities request with no request parameter.</ctl:message>
                    <xsl:variable name="isCorrect">
                        <ctl:call-function name="spsFunctions:checkExceptionReport">
                            <ctl:with-param name="exceptionReport" select="$requestNoRequest/*" />
                            <ctl:with-param name="exceptionCodeToCheck" select="string('MissingParameterValue')" />
                            <ctl:with-param name="locatorToCheck" select="string('Request')" />
                        </ctl:call-function>
                    </xsl:variable>
                    <ctl:message>The validity check returned:  <xsl:value-of select="$isCorrect" /></ctl:message>
                    <xsl:if test="not(boolean($isCorrect))">
                        <ctl:message>The server did not return the expected exception report response to a GetCapabilities request with no request parameter specified.  "<xsl:value-of select="$requestNoRequest" />" was returned instead.</ctl:message>
                        <ctl:fail />
                    </xsl:if>
                </xsl:if>
            </xsl:otherwise>
        </xsl:choose>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.GetCapabilities-KVPRequestServiceParameterHandling.1">
      <ctl:param name="serviceURL" />
      <ctl:assertion>The server returns a valid error report message with an exception code of InvalidParameterValue when the service key value is not SPS. </ctl:assertion>
      <ctl:comment>Pass if the exception report is valid and the exceptionCode parameter contains InvalidParameterValue; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the server handles invalid service key values correctly.">ATS_URL#SPS.GetCapabilities-KVPRequestServiceParameterHandling</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.)  HTTP GET request with a service parameter that contains a value other than SPS
                -->
        <xsl:variable name="invalidServiceParameterValue" select="kaldsfjlksdajf" />
        <xsl:variable name="requestInvalidServiceKeyValue">
            <ctl:request>
                <ctl:url>
                    <xsl:value-of select="$serviceURL" />
                </ctl:url>
                <ctl:method>get</ctl:method>
                <ctl:param name="request">GetCapabilities</ctl:param>
                <ctl:param name="service"><xsl:value-of select="$invalidServiceParameterValue" /></ctl:param>
                <!--Parser to get response-->
                <!--<parsers:XMLValidatingParser>
                    <parsers:schemas>
                        <parsers:schema type="url">
                            <ctl:call-function name="spsFunctions:getSchemaLocation">
                                <ctl:with-param name="schemaName" select="string('owsExceptionReport.xsd')" />
                            </ctl:call-function>
                        </parsers:schema>
                    </parsers:schemas>
                </parsers:XMLValidatingParser>-->
            </ctl:request>
        </xsl:variable>
        <xsl:choose>
            <xsl:when test="not($requestInvalidServiceKeyValue/*)">
                <ctl:message>The server did not return or a response or the response was not a valid exception report.</ctl:message>
                <ctl:fail />
            </xsl:when>
            <xsl:otherwise>
                <ctl:message>Checking the validity of the response "<xsl:value-of select="$requestInvalidServiceKeyValue" />" to a GetCapabilities request with an invalid service value of "<xsl:value-of select="$invalidServiceParameterValue" />".</ctl:message>
                <xsl:variable name="isCorrect">
                    <ctl:call-function name="spsFunctions:checkExceptionReport">
                        <ctl:with-param name="exceptionReport" select="$requestInvalidServiceKeyValue" />
                        <ctl:with-param name="exceptionCodeToCheck" select="string('InvalidParameterValue')" />
                        <ctl:with-param name="locatorToCheck" select="string('Service')" />
                    </ctl:call-function>
                </xsl:variable>
                <ctl:message>The validity check returned:  <xsl:value-of select="$isCorrect" /></ctl:message>
                <xsl:if test="not(boolean($isCorrect))">
                    <ctl:message>The response to a GetCapabilities request with an invalid service parameter (<xsl:value-of select="$invalidServiceParameterValue" />) does not match the expected response.</ctl:message>
                    <ctl:fail />
                </xsl:if>
            </xsl:otherwise>
        </xsl:choose>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.GetCapabilities-KVPRequestRequestParameterHandling.1">
      <ctl:param name="serviceURL" />
      <ctl:assertion>The server returns a valid error report message with an exception code of InvalidParameterValue when the request key value is not GetCapabilities. </ctl:assertion>
      <ctl:comment>Pass if the exception report is valid and the exceptionCode parameter contains InvalidParameterValue; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the server handles invalid request key values correctly.">ATS_URL#SPS.GetCapabilities-KVPRequestRequestParameterHandling</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.)  HTTP GET request with a request parameter that contains a value other than GetCapabilities
                -->
        <xsl:variable name="invalidRequestParameterValue" select="lkasjflksadjflkjasdf" />
        <xsl:variable name="requestInvalidRequestKeyValue">
            <ctl:request>
                <ctl:url>
                    <xsl:value-of select="$serviceURL" />
                </ctl:url>
                <ctl:method>get</ctl:method>
                <ctl:param name="request"><xsl:value-of select="$invalidRequestParameterValue" /></ctl:param>
                <ctl:param name="service">SPS</ctl:param>
                <!--Parser to get response-->
                <!--<parsers:XMLValidatingParser>
                    <parsers:schemas>
                        <parsers:schema type="url">
                            <ctl:call-function name="spsFunctions:getSchemaLocation">
                                <ctl:with-param name="schemaName" select="string('owsExceptionReport.xsd')" />
                            </ctl:call-function>
                        </parsers:schema>
                    </parsers:schemas>
                </parsers:XMLValidatingParser>-->
            </ctl:request>
        </xsl:variable>
        <xsl:choose>
            <xsl:when test="not($requestInvalidRequestKeyValue/*)">
                <ctl:message>The server did not return or a response or the response was not a valid exception report.</ctl:message>
                <ctl:fail />
            </xsl:when>
            <xsl:otherwise>
                <xsl:variable name="isCorrect">
                    <ctl:call-function name="spsFunctions:checkExceptionReport">
                        <ctl:with-param name="exceptionReport" select="$requestInvalidRequestKeyValue" />
                        <ctl:with-param name="exceptionCodeToCheck" select="string('InvalidParameterValue')" />
                        <ctl:with-param name="locatorToCheck" select="string('Request')" />
                    </ctl:call-function>
                </xsl:variable>
                <xsl:if test="not(boolean($isCorrect))">
                    <ctl:message>The response to a GetCapabilities request with an invalid request parameter (<xsl:value-of select="$invalidRequestParameterValue" />) does not match the expected response.</ctl:message>
                    <ctl:fail />
                </xsl:if>
            </xsl:otherwise>
        </xsl:choose>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.GetCapabilities-ResponseMain.1">
        <ctl:param name="serviceURL" />
        <ctl:assertion>All assertions related to an SPS GetCapabilities response are valid.</ctl:assertion>
        <ctl:comment>Executes a GetCapabilities request and checks the response for validity</ctl:comment>
        <ctl:link></ctl:link>
        <ctl:code>
            <!--PUT TEST CODE HERE-->
            <!--
                            1.)  Valid HTTP GET request for GetCapabilities.  Store response in a variable.
                            2.) Validate response against the GetCapabilities schema.  Call sps:general-SPS.General-ValidResponse.1
                            3.) Loop through the operations listed in the OperationsMetadata section of the GetCapabilities response and store the URL for each operation (if it exists) for use in later tests.  Fail if one of the mandatory operations is missing.
                        -->
              <ctl:message>Issuing a valid GetCapabilities request to <xsl:value-of select="$serviceURL" /></ctl:message>
              <xsl:variable name="getCapabilitiesResponse">
                <ctl:request>
                    <ctl:url>
                        <xsl:value-of select="$serviceURL" />
                    </ctl:url>
                    <ctl:method>get</ctl:method>
                    <ctl:param name="request">GetCapabilities</ctl:param>
                    <ctl:param name="service">SPS</ctl:param>
                    <!--Parser to get response-->
                    <!--<parsers:XMLValidatingParser>
                        <parsers:schemas>
                            <parsers:schema type="url">
                                <ctl:call-function name="spsFunctions:getSchemaLocation">
                                <ctl:with-param name="schemaName" select="string('spsGetCapabilities.xsd')" />
                            </ctl:call-function>
                            </parsers:schema>
                        </parsers:schemas>
                    </parsers:XMLValidatingParser>-->
                </ctl:request>
              </xsl:variable>
              <ctl:message>The server responded to a valid GetCapabilities request with the following message:  <xsl:value-of select="$getCapabilitiesResponse/*" /></ctl:message>
              <xsl:choose>
                <xsl:when test="not($getCapabilitiesResponse/*)">
                    <ctl:message>The server did not return a response to a valid GetCapabilities request, or the response was not a valid SPS Capabilities document.</ctl:message>
                    <ctl:fail />
                </xsl:when>
                <xsl:otherwise>
                    <!--Check for mandatory operations-->
                    <ctl:call-test name="sps:core-SPS.GetCapabilities-ResponseOperationMetadataMandatoryOperations.1">
                        <ctl:with-param name="getCapabilitiesResponse" select="$getCapabilitiesResponse" />
                    </ctl:call-test>
                    <!--Check for optional operations-->
                    <ctl:call-test name="sps:core-SPS.GetCapabilities-ResponseOperationMetadataOptionalOperations.1">
                        <ctl:with-param name="getCapabilitiesResponse" select="$getCapabilitiesResponse" />
                    </ctl:call-test>
                    <!--Check for valid SensorOffering elements-->
                    <ctl:call-test name="sps:core-SPS.GetCapabilities-ResponseContentsSensorOfferings.1">
                        <ctl:with-param name="getCapabilitiesResponse" select="$getCapabilitiesResponse" />
                    </ctl:call-test>
                    <!--Check for valid SensorDefinition elements-->
                    <ctl:call-test name="sps:core-SPS.GetCapabilities-ResponseContentsSensorOfferingsValidSensorDefinition.1">
                        <ctl:with-param name="getCapabilitiesResponse" select="$getCapabilitiesResponse" />
                    </ctl:call-test>
                    <!--Check for valid PhenomenonOffering elements-->
                    <ctl:call-test name="sps:core-SPS.GetCapabilities-ResponseContentsPhenomenonOfferings.1">
                        <ctl:with-param name="getCapabilitiesResponse" select="$getCapabilitiesResponse" />
                    </ctl:call-test>
                </xsl:otherwise>
              </xsl:choose>
              <xsl:value-of select="$getCapabilitiesResponse/*" />
        </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.GetCapabilities-ResponseOperationMetadataMandatoryOperations.1">
      <ctl:param name="getCapabilitiesResponse" />
      <ctl:assertion>The OperationsMetadata section lists the mandatory operations of the SPS.</ctl:assertion>
      <ctl:comment>Pass if the service lists the GetCapabilities, DescribeTasking, Submit, and DescribeResultAccess operations with the proper bindings in the OperationsMetadata section; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the OperationsMetadata section advertises the mandatory operations of the SPS.">ATS_URL#SPS.GetCapabilities-ResponseOperationMetadataMandatoryOperations</ctl:link>
      <ctl:code>
                <xsl:variable name="getCapabilitiesElement" select="$getCapabilitiesResponse//ows:OperationsMetadata/ows:Operation[@name='GetCapabilities']" />
                <xsl:variable name="describeTaskingElement" select="$getCapabilitiesResponse//ows:OperationsMetadata/ows:Operation[@name='DescribeTasking']" />
                <xsl:variable name="submitElement" select="$getCapabilitiesResponse//ows:OperationsMetadata/ows:Operation[@name='Submit']" />
                <xsl:variable name="describeResultAccessElement" select="$getCapabilitiesResponse//ows:OperationsMetadata/ows:Operation[@name='DescribeResultAccess']" />
                <!--Check for a GetCapabilities operation-->
                <xsl:if test="not($getCapabilitiesElement/*)">
                    <ctl:message>The GetCapabilities operation is a mandatory operation.  Therefore, it must be listed in the OperationsMetadata section of the GetCapabilities document.</ctl:message>
                    <ctl:fail />
                </xsl:if>
                <!--Check for a DescribeTasking operation--> 
                <xsl:if test="not($describeTaskingElement/*)">
                    <ctl:message>The DescribeTasking operation is a mandatory operation.  Therefore, it must be listed in the OperationsMetadata section of the GetCapabilities document.</ctl:message>
                    <ctl:fail />
                </xsl:if>
                <!--Check for a Submit operation-->
                <xsl:if test="not($submitElement/*)">
                    <ctl:message>The Submit operation is a mandatory operation.  Therefore, it must be listed in the OperationsMetadata section of the GetCapabilities document.</ctl:message>
                    <ctl:fail />
                </xsl:if>
                <!--Check for a DescribeResultAccess operation--> 
                <xsl:if test="not($describeResultAccessElement/*)">
                    <ctl:message>The DescribeResultAccess operation is a mandatory operation.  Therefore, it must be listed in the OperationsMetadata section of the GetCapabilities document.</ctl:message>
                    <ctl:fail />
                </xsl:if>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.GetCapabilities-ResponseOperationMetadataOptionalOperations.1">
      <ctl:param name="getCapabilitiesResponse" />
      <ctl:assertion>Any non-mandatory operations advertised in the OperationsMetadata section have valid SPS method names.</ctl:assertion>
      <ctl:comment>Pass if the service lists operations in addition to the mandatory operations, and each of the advertised operations has a valid SPS operation name; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that any non-mandatory operations listed in the OperationsMetadata section are valid SPS operation names.  This is still up for debate and will probably not be part of the final tests.">ATS_URL#SPS.GetCapabilities-ResponseOperationMetadataOptionalOperations</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.)  Using the GetCapabilities response from above, check to see if the additional methods listed in the OperationsMetadata section are valid SPS method names.
                -->
        <xsl:for-each select="$getCapabilitiesResponse//ows:OperationsMetadata//ows:Operation">
            <xsl:variable name="operationName" select="@name" />
            <!--TODO:  Complete this test.-->
        </xsl:for-each>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.GetCapabilities-ResponseContentsSensorOfferings.1">
      <ctl:param name="getCapabilitiesResponse" />
      <ctl:assertion>Each SensorOffering sub-element (AreaOfService, Phenomenon, SensorDefinition, and SensorID) has a value.</ctl:assertion>
      <ctl:comment>Pass if each sub-element of a SensorOffering element has a value; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that each SensorOffering has appropriate values for its sub-elements.">ATS_URL#SPS.GetCapabilities-ResponseContentsSensorOfferings</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.)  Using the GetCapabilities response from above, loop through the SensorOffering sub-elements to ensure that each sub-element contains a value.
                -->
        <xsl:for-each select="$getCapabilitiesResponse//sps:Contents/sps:SensorOfferingList/sps:SensorOffering">
            <xsl:variable name="areaOfService" select="sps:AreaOfService" />
            <xsl:variable name="phenomenon" select="normalize-space(sps:Phenomenon)" />
            <xsl:variable name="sensorDefinition" select="normalize-space(sps:SensorDefinition)" />
            <xsl:variable name="sensorID" select="normalize-space(sps:SensorID)" />
            <!--Check AreaOfService (for a child element or more?)-->
            <xsl:if test="not($areaOfService/*)">
                <!--TODO: Check AreaOfService-->
                <ctl:message>The AreaOfService value for SensorOffering with SensorID <xsl:value-of select="$sensorID" /> is null.</ctl:message>
                <ctl:fail />
            </xsl:if>
            <!--Check Phenomenon (for an empty string or an invalid URN?)-->
            <xsl:if test="string-length($phenomenon)=0">
                <ctl:message>The Phenomenon value for SensorOffering with SensorID <xsl:value-of select="$sensorID" /> is null.</ctl:message>
                <ctl:fail />
            </xsl:if>
            <!--Check SensorDefinition (for an empty string)-->
            <xsl:if test="string-length($sensorDefinition)=0">
                <ctl:message>The SensorDefinition value for SensorOffering with SensorID <xsl:value-of select="$sensorID" /> is null.</ctl:message>
                <ctl:fail />
            </xsl:if>
            <!--Check SensorID (for an empty string or an invalid URN?)-->
            <xsl:if test="string-length($sensorID)=0">
                <ctl:message>A SensorID value is null.</ctl:message>
                <ctl:fail />
            </xsl:if>
        </xsl:for-each>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.GetCapabilities-ResponseContentsSensorOfferingsValidSensorDefinition.1">
      <ctl:param name="getCapabilitiesResponse" />
      <ctl:assertion>The SensorDefinition element of each SensorOffering element links to a valid SensorML or TML document.</ctl:assertion>
      <ctl:comment>Pass if the SensorDefinition element of each SensorOffering element links to a valid SensorML or TML document; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the value provided in the SensorDefinition field of each SensorOffering links to a valid SensorML or TML document.">ATS_URL#SPS.GetCapabilities-ResponseContentsSensorOfferingsValidSensorDefinition</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.)  Using the GetCapabilities response from above, obtain the value of each SensorDefinition element using a loop.
                    2.)  Store the value of the SensorDefinition element in a variable.
                    3.)  Request (HTTP) the value in the SensorDefinition variable if a value exists, else fail.
                    4.)  If a response is returned, then validate the response against the appropriate schema (SensorML or TML), else fail.
                    5.)  If the response validates against its associated schema then pass, else fail.
                    6.)  Check if the sensorID in the SensorML or TML document matches the requested SensorID?
                -->
        <xsl:for-each select="$getCapabilitiesResponse//sps:Contents/sps:SensorOfferingList/sps:SensorOffering">
            <!--Store the associated SensorID element value for later use-->
            <xsl:variable name="sensorID" select="sps:SensorID" />
            <xsl:variable name="sensorDefinition" select="normalize-space(sps:SensorDefinition)" />
            <!--Create a request based on the value in the SensorDefiniton element and store the response in a variable-->
            <ctl:message>Issuing a request for the sensor definition of "<xsl:value-of select="$sensorID" />" to the following URL:  <xsl:value-of select="$sensorDefinition" /></ctl:message>
            <xsl:variable name="sensorDefinitionResponse">
                <ctl:request>
                    <ctl:url>
                        <xsl:value-of select="$sensorDefinition" />
                    </ctl:url>
                    <ctl:method>get</ctl:method>
                    <!--Parser to get response-->
                    <parsers:XMLValidatingParser>
                        <parsers:schemas>
                            <!--<xsl:choose>
                                <xsl:when test="response//sml:SensorML">-->
                                    <parsers:schema type="url">
                                        <ctl:call-function name="spsFunctions:getSchemaLocation">
                                            <ctl:with-param name="schemaName" select="string('sensorML.xsd')" />
                                        </ctl:call-function>
                                    </parsers:schema>
                                <!--</xsl:when>
                                <xsl:otherwise>-->
                                    <parsers:schema type="url">
                                        <ctl:call-function name="spsFunctions:getSchemaLocation">
                                            <ctl:with-param name="schemaName" select="string('tml.xsd')" />
                                        </ctl:call-function>
                                    </parsers:schema>
                                <!--</xsl:otherwise>
                            </xsl:choose>-->
                        </parsers:schemas>
                    </parsers:XMLValidatingParser>
                </ctl:request>
            </xsl:variable>
            <ctl:message>The server returned the following response:  <xsl:value-of select="$sensorDefinitionResponse/*" /></ctl:message>
            <xsl:choose>
                <xsl:when test="not($sensorDefinitionResponse/*)">
                    <ctl:message>The advertised value in the SensorDefinition element for <xsl:value-of select="$sensorID" /> did not return a response or did not link to a valid SensorML or TML document.</ctl:message>
                    <ctl:fail />
                </xsl:when>
                <xsl:otherwise>
                    <!--TODO:  Verify that the ID of the sensor matches the requested sensorID-->
                    <xsl:choose>
                        <xsl:when test="$sensorDefinitionResponse//sml:SensorML">
                            <xsl:variable name="responseSensorID" select="$sensorDefinitionResponse//sml:Term[contains(@definition,':uniqueID')]/sml:value" />
                            <xsl:if test="not($responseSensorID)">
                                <ctl:message>There was no sensorID specified in the returned SensorML document.</ctl:message>
                                <ctl:fail />
                            </xsl:if>
                            <xsl:if test="not($responseSensorID=$sensorID)">
                                <ctl:message>The sensorID in the returned SensorML document (<xsl:value-of select="$responseSensorID" />) does not match the sensorID specified in the SensorOffering (<xsl:value-of select="$sensorID" />).</ctl:message>
                                <ctl:fail />
                            </xsl:if>
                        </xsl:when>
                        <xsl:when test="$sensorDefinitionResponse//tml:tml">
                            <xsl:variable name="responseSensorID" select="$sensorDefinitionResponse//tml:tml/@uid" />
                            <xsl:if test="not($responseSensorID)">
                                <ctl:message>There was no sensorID specified in the returned TML document.</ctl:message>
                                <ctl:fail />
                            </xsl:if>
                            <xsl:if test="not($responseSensorID=$sensorID)">
                                <ctl:message>The sensorID in the returned TML document (<xsl:value-of select="$responseSensorID" />) does not match the sensorID specified in the SensorOffering (<xsl:value-of select="$sensorID" />).</ctl:message>
                                <ctl:fail />
                            </xsl:if>   
                        </xsl:when>
                        <xsl:otherwise>
                            <ctl:message>The returned response did not validate according to the SensorML or TML schema.</ctl:message>
                            <ctl:fail />
                        </xsl:otherwise>
                    </xsl:choose>
                </xsl:otherwise>
            </xsl:choose>
        </xsl:for-each>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.GetCapabilities-ResponseContentsPhenomenonOfferings.1">
      <ctl:param name="getCapabilitiesResponse" />
      <ctl:assertion>Each PhenomenonOffering sub-element (Phenomenon and SensorID) has a value.</ctl:assertion>
      <ctl:comment>Pass if each PhenomenonOffering sub-element has a value; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that each PhenomenonOffering has appropriate values for its sub-elements.">ATS_URL#SPS.GetCapabilities-ResponseContentsPhenomenonOfferings</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.)  Using the GetCapabilities response from above, loop through each sub-element of each PhenomenonOffering
                    2.)  Check to ensure that each sub-element's inner text property has a value.  Pass if each sub-element has a value, fail otherwise.
                -->
        <xsl:for-each select="$getCapabilitiesResponse//sps:Contents/sps:PhenomenonOfferingList/sps:PhenomenonOffering">
            <!--Check the Phenomenon element (ensure that each Phenomenon listed matches a Phenomenon listed in a SensorOffering element?)-->
            <xsl:if test="sps:Phenomenon">
                <xsl:if test="string-length(normalize-space())=0"><!--Check to see if this Phenomenon is in a URN format?-->
                    <ctl:message>The Phenomenon element value for a PhenomenonOffering is an empty string.</ctl:message>
                    <ctl:fail />
                </xsl:if>
            </xsl:if>
            <!--Check each SensorID element (ensure that each SensorID element listed matches a SensorID listed in the SensorOffering element?)-->
            <xsl:for-each select="sps:SensorID">
                <xsl:if test="string-length(normalize-space())=0">
                    <ctl:message>The SensorID element value for a PhenomenonOffering is an empty string</ctl:message>
                    <ctl:fail />
                </xsl:if>
            </xsl:for-each>
        </xsl:for-each>
      </ctl:code>
    </ctl:test>
    
    <!--DescribeTasking tests-->
    <ctl:test name="sps:core-SPS.DescribeTasking-RequestInvalidSensorIDs.1">
      <ctl:param name="describeTaskingURL" />
      <ctl:assertion>The server returns a valid error report message with a value of UnknownSensorID for the exceptionCode parameter and a list of the unknown sensor IDs in the locator parameter when one or more invalid sensor ID(s) are supplied in the request.</ctl:assertion>
      <ctl:comment>Pass if the server returns a valid error report message with an exceptionCode parameter of UnknownSensorID and a list of the unknown sensor IDs in the locator parameter; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the server handles invalid sensor ID(s) correctly.">ATS_URL#SPS.DescribeTasking-RequestInvalidSensorIDs</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.)  HTTP POST DescribeTasking request with one random sensorID.
                    2.)  Validate response against ExceptionReport schema.
                    3.)  If response validates, then check that the exceptionCode parameter is "UnknownSensorID" and that the requested sensorID is listed in the locator parameter.
                    4.)  Repeat 1 - 3 with a set of random sensor IDs to test how the server handles multiple sensorIDs
                -->
        <xsl:variable name="sensorIDs" select="blah,adsjflkasjdflkdsajf,ewioruowireuoierwu,1384982348924988923893298438294" />
        <xsl:variable name="describeTaskingResponse">
            <ctl:call-function name="spsFunctions:describeTaskingRequest">
                <ctl:with-param name="describeTaskingURL" select="$describeTaskingURL" />
                <ctl:with-param name="sensorIDs" select="$sensorIDs" />
            </ctl:call-function>
        </xsl:variable>
        <xsl:choose>
            <xsl:when test="not($describeTaskingResponse/*)">
                <ctl:message>The server did not return a response to an invalid DescribeTasking request or the response was not a valid exception.</ctl:message>
                <ctl:fail />
            </xsl:when>
            <xsl:otherwise>
                <xsl:for-each select="$describeTaskingResponse//ows:ExceptionReport/ows:Exception">
                    <xsl:variable name="locatorValue" select="@locator" />
                    <xsl:if test="not(@exceptionCode='UnknownSensorID')">
                        <ctl:message>An exceptionCode of UnknownSensorID was expected in the response.  "<xsl:value-of select="@exceptionCode" />" was provided instead.</ctl:message>
                        <ctl:fail />
                    </xsl:if>
                    <!--TODO:  Figure out what to do here-->
                    <xsl:variable name="sensorIDSequence" select="tokenize($sensorIDs,',')" />
                    <xsl:variable name="locatorSequence" select="tokenize($locatorValue,',')" />
                    <xsl:for-each select="$sensorIDSequence">
                        <xsl:variable name="currentItem" select="." />
                        <xsl:if test="empty(index-of($locatorSequence,$currentItem))">
                            <ctl:message>The locator value was expected to contain "<xsl:value-of select="$currentItem" />".</ctl:message>
                            <ctl:fail />
                        </xsl:if>
                    </xsl:for-each>
                    <!--<xsl:if test="not(empty($sensorIDSequence except $locatorSequence))">
                                                    <ctl:message>The locator value was expected to be one of the following values:  <xsl:value-of select="$sensorIDs" />; "<xsl:value-of select="$locatorValue" />" was provided instead.</ctl:message>
                                                    <ctl:fail />
                                             </xsl:if>-->
                </xsl:for-each>
            </xsl:otherwise>
        </xsl:choose>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeTasking-RequestNullSensorID.1">
      <ctl:param name="describeTaskingURL" />
      <ctl:assertion>The server returns a valid error report message with a value of InvalidParameterValue for the exceptionCode parameter when no SensorID value is supplied in the request.</ctl:assertion>
      <ctl:comment>Pass if the server returns a valid error report message with an exceptionCode parameter of InvalidParameterValue; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the server handles a request with a null SensorID correctly.">ATS_URL#SPS.DescribeTasking-RequestNullSensorID</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.)  HTTP POST DescribeTasking request with an empty sensorID.
                    2.)  Validate response against ExceptionReport schema.
                    3.)  If response validates, then check that the exceptionCode parameter is "InvalidParameterValue".
                -->
        <xsl:variable name="describeTaskingResponse">
            <ctl:call-function name="spsFunctions:describeTaskingRequest">
                <ctl:with-param name="describeTaskingURL" select="$describeTaskingURL" />
                <ctl:with-param name="sensorIDs" select="string('')" />
            </ctl:call-function>
        </xsl:variable>
        <xsl:choose>
            <xsl:when test="not($describeTaskingResponse/*)">
                <ctl:message>The server did not return a response to an invalid DescribeTasking request or the response was not a valid exception.</ctl:message>
                <ctl:fail />
            </xsl:when>
            <xsl:otherwise>
                <xsl:for-each select="$describeTaskingResponse//ows:ExceptionReport/ows:Exception">
                    <xsl:variable name="locatorValue" select="@locator" />
                    <xsl:if test="not(@exceptionCode='InvalidParameterValue')">
                        <ctl:message>An exceptionCode of InvalidParameterValue was expected in the response</ctl:message>
                        <ctl:fail />
                    </xsl:if>
                    <xsl:if test="not($locatorValue='sensorID')">
                        <ctl:message>The locator value was expected to be "sensorID"; "<xsl:value-of select="$locatorValue" />" was provided instead.</ctl:message>
                        <ctl:fail />
                    </xsl:if>
                </xsl:for-each>
            </xsl:otherwise>
        </xsl:choose>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeTasking-ResponseMain.1">
      <ctl:param name="describeTaskingURL" />
      <ctl:param name="getCapabilitiesResponse" />
      <ctl:assertion>The response to a DescribeTasking request is valid.</ctl:assertion>
      <ctl:comment>Pass if each InputDescriptor element contains values for each of its sub-elements and these sub-element values appear to be valid; fail otherwise.</ctl:comment>
      <ctl:link title="Verify a DescribeTasking response."></ctl:link>
      <ctl:code>
        <!--Loop through the SensorID values in the Capabilities document-->
        <xsl:for-each select="$getCapabilitiesResponse//sps:Contents/sps:SensorOfferingList/sps:SensorOffering/sps:SensorID">
            <!--Call DescribeTasking for each SensorID-->
            <xsl:variable name="describeTaskingResponse">
                <ctl:call-function name="spsFunctions:describeTaskingRequest">
                    <ctl:with-param name="describeTaskingURL" select="$describeTaskingURL" />
                    <ctl:with-param name="sensorIDs" select="." />
                </ctl:call-function>
            </xsl:variable>
            <ctl:call-function name="spsFunctions:validateResponse">
                <ctl:with-param name="responseDocument" select="$describeTaskingResponse" />
            </ctl:call-function>
            <xsl:choose>
                <xsl:when test="not(describeTaskingResponse/*)">
                    <ctl:message>No response was returned from the server for a DescribeTasking request with sensorID="<xsl:value-of select="." />", or the response did not validate according to the DescribeTasking schema.</ctl:message>
                    <ctl:fail />
                </xsl:when>
                <xsl:otherwise>
                    <!--Using the DescribeTasking response, ensure that the values in the sub-elements are valid by calling sub-tests-->
                    <!--Ensure that the SensorID in the response matches the SensorID provided in the request-->
                    <ctl:call-test name="sps:core-SPS.DescribeTasking-ResponseMatchingSensorIDs.1">
                        <ctl:with-param name="requestedSensorID" select="." />
                        <ctl:with-param name="describeTaskingResponse" select="$describeTaskingResponse" />
                    </ctl:call-test>
                    <!--Ensure that the InputDescriptor elements contain values for their sub-elements-->
                    <ctl:call-test name="sps:core-SPS.DescribeTasking-ResponseValidInputDescriptor.1">
                        <ctl:with-param name="requestedSensorID" select="." />
                        <ctl:with-param name="describeTaskingResponse" select="$describeTaskingResponse" />
                    </ctl:call-test>
                    <!--Ensure that the parameterID of each InputDescriptor contains a value and that the parameterID is unique-->
                    <ctl:call-test name="sps:core-SPS.DescribeTasking-ResponseValidInputDescriptorParameterID.1">
                        <ctl:with-param name="requestedSensorID" select="." />
                        <ctl:with-param name="describeTaskingResponse" select="$describeTaskingResponse" />
                    </ctl:call-test>
                    <!--If an exception report is returned, ensure that it is a valid exception report for the DescribeTasking operation-->
                    <ctl:call-test name="sps:core-SPS.DescribeTasking-ValidException.1">
                        <ctl:with-param name="describeTaskingResponse" select="$describeTaskingResponse" />
                    </ctl:call-test>
                </xsl:otherwise>
            </xsl:choose>
        </xsl:for-each>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeTasking-ResponseMatchingSensorIDs.1">
      <ctl:param name="requestedSensorID" />
      <ctl:param name="describeTaskingResponse" />
      <ctl:assertion>The sensorID field of each TaskingDescriptor element is one of the SensorID values provided in the request.</ctl:assertion>
      <ctl:comment>Pass if the SensorID value in each TaskingDescriptor element is one of the SensorID values supplied in the DescribeTasking request; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the sensorID field of each TaskingDescriptor element is one of the SensorID values provided in the request.">ATS_URL#SPS.DescribeTasking-ResponseMatchingSensorIDs</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.)  HTTP POST valid DescribeTasking request with one or more valid sensorID(s).  Get each advertised SensorID from the Capabilities document.
                    2.) Validate response against DescribeTaskingResponse schema.
                    3.)  If the reponse validates, then check that the SensorID value in each of the TaskingDescriptor elements matches one the request sensorID(s).
                -->
        <xsl:variable name="responseSensorID" select="$describeTaskingResponse/sps:DescribeTaskingRequestResponse/sps:taskingDescriptor/sps:sensorID" />
        <xsl:if test="not($responseSensorID=$requestedSensorID)">
            <ctl:message>The sensorID of the response "<xsl:value-of select="$responseSensorID" />" does not match the sensorID in the request "<xsl:value-of select="$requestedSensorID" />".</ctl:message>
            <ctl:fail />
        </xsl:if>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeTasking-ResponseValidInputDescriptor.1">
      <ctl:param name="requestedSensorID" />
      <ctl:param name="describeTaskingResponse" />
      <ctl:assertion>Each InputDescriptor element contains appropriate values for its sub-elements.</ctl:assertion>
      <ctl:comment>Pass if each InputDescriptor element contains values for each of its sub-elements and these sub-element values appear to be valid; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that each InputDescriptor element contains appropriate values for its sub-elements.  This is probably tested through schema validation, so this test may be unnecessary.">ATS_URL#SPS.DescribeTasking-ResponseValidInputDescriptor</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeTasking-ResponseValidInputDescriptorParameterID.1">
      <ctl:param name="requestedSensorID" />
      <ctl:param name="describeTaskingResponse" />
      <ctl:assertion>The parameterID of each InputDescriptor element contains a value.</ctl:assertion>
      <ctl:comment>Pass if the parameterID element of each InputDescriptor element contains a value and each parameterID element has a unique value; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the parameterID of each InputDescriptor element contains a value.">ATS_URL#SPS.DescribeTasking-ResponseValidInputDescriptorParameterID</ctl:link>
      <ctl:code>
        <!--
                    1.)  Store the parameterID values in a variable
                    2.)  Store the distinct parameterID values in a variable
                    3.)  Loop through each parameterID value and ensure that it is not null
                    4.)  Compare the distinct parameterID values with the initial parameterID values to ensure that they match
                -->
        <!--Get the parameterID values from the response-->
        <xsl:variable name="parameterIDs" select="$describeTaskingResponse//sps:InputDescriptor/@sps:parameterID" />
        <!--Determine the distinct parameterID values-->
        <xsl:variable name="distinctParameterIDs" select="distinct-values($parameterIDs)" />
        <!--Loop through the parameterID values in the response to ensure that each is not null-->
        <xsl:for-each select="$parameterIDs">
            <xsl:if test="string-length()=0">
                <ctl:message>A parameterID for <xsl:value-of select="$requestedSensorID" /> is null.</ctl:message>
                <ctl:fail />
            </xsl:if>
        </xsl:for-each>
        <!--Compare the parameterID values with the distinctParameterID values to ensure that all parameterID values are distinct-->
        <xsl:if test="not($parameterIDs=$distinctParameterIDs)">
            <ctl:message>One or more parameterID values for <xsl:value-of select="$requestedSensorID" /> are not unique</ctl:message>
            <ctl:fail />
        </xsl:if>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeTasking-ValidException.1">
      <ctl:param name="describeTaskingResponse" />
      <ctl:assertion>An exception message returned by the server is a valid exception message for the DescribeTasking operation.</ctl:assertion>
      <ctl:comment>Pass if a returned exception message is a valid exception report and has an exceptionCode value that is valid for the DescribeTasking operation; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that any exception message returned by the server is a valid exception message for the DescribeTasking operation">ATS_URL#SPS.DescribeTasking-ValidException</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
      </ctl:code>
    </ctl:test>
    
    <!--Submit tests-->
    <ctl:test name="sps:core-SPS.Submit-RequestMain.1">
      <ctl:param name="getCapabilitiesResponse" />
      <ctl:param name="describeTaskingURL" />
      <ctl:param name="submitURL" />
      <ctl:assertion>All Submit request assertions are satisfied.</ctl:assertion>
      <ctl:comment>Pass if all Submit request assertions are satisfied; fail otherwise.</ctl:comment>
      <ctl:link title=""></ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.)  DescribeTasking request/response.
                    2.)  Based on response generate form
                    3.)  User clicks Submit button after filling in form values
                    4.)  Generate Submit request
                    5.)  Retrieve SumbitRequestResponse from the server
                    6.)  Valid SubmitRequestResponse
                -->
        <!--Get the SensorID values from the Capabilities document-->
        <xsl:variable name="sensorIDs" select="$getCapabilitiesResponse/sps:Contents/sps:SensorOfferingList//sps:SensorOffering/sps:SensorID" />
        <!--Provide a form to the user allowing them to pick a sensor for which Submit requests will be posted-->
        <xsl:variable name="chooseSensorForm">
            <ctl:form height="640" width="800">
               <body>
                  <h2>Please choose a sensor for performing Submit operation tests.</h2>
                  <blockquote>
                     <table border="1" padding="4" bgcolor="#00ffff">
                        <tr>
                           <td align="left">Sensor ID:</td>                        
                           <td align="center">
                              <select name="sensorIDDropDown">
                                <xsl:for-each select="$sensorIDs">
                                    <xsl:variable name="sensorID" select="." />
                                    <option><xsl:attribute name="value"><xsl:value-of select="$sensorID" /></xsl:attribute><xsl:value-of select="$sensorID" /></option> 
                                </xsl:for-each>
                              </select>
                           </td>
                        </tr>
                     </table>
                  </blockquote>
                  <input type="submit" value="Select"/>
               </body>
            </ctl:form>
        </xsl:variable>
        <!--Get the user selected sensorID-->
        <xsl:variable name="selectedSensorID" select="$chooseSensorForm/select[@name='sensorIDDropDown']/option[@selected='selected']" />
        <!--Call DescribeTasking for this sensorID-->
        <xsl:variable name="describeTaskingResponse">
            <ctl:call-function name="spsFunctions:describeTaskingRequest">
                <ctl:with-param name="describeTaskingURL" select="$describeTaskingURL" />
                <ctl:with-param name="sensorIDs" select="$selectedSensorID" />
            </ctl:call-function>
        </xsl:variable>
        <xsl:choose>
            <xsl:when test="not($describeTaskingResponse/*)">
                <ctl:message>Unable to construct a Submit request form containing taskable parameters, since the server did not return a valid response to the DescribeTasking request for "<xsl:value-of select="$selectedSensorID" />".</ctl:message>
                <ctl:fail />
            </xsl:when>
            <xsl:otherwise>
                <!--Display a form allowing the user to enter in values for the taskable parameters for the selected sensor-->
                <xsl:variable name="enterTaskingOptionsForm">
                    <ctl:form height="640" width="800">
                       <body>
                          <h2>Please enter values for a WNS URL and User ID</h2>
                          <blockquote>
                             <table border="1" padding="4" bgcolor="#00ffff">
                                    <tr>
                                        <td>WNS URL:</td>
                                        <td><input id="wnsURL" type="text" /></td>
                                    </tr>
                                    <tr>
                                        <td>WNS User ID:</td>
                                        <td><input id="wnsUserID" type="text" /></td>
                                    </tr>
                             </table>
                          </blockquote>
                          <h2>Please enter valid values for the available taskable parameters for <xsl:value-of select="$selectedSensorID" /></h2>
                          <blockquote>
                             <table border="1" padding="4" bgcolor="#00ffff">
                                <th>
                                    <td>Parameter ID</td>
                                    <td>Description</td>
                                    <td>Use</td>
                                    <td>Type</td>
                                    <td>Definition</td>
                                    <td>Units</td>
                                    <td>Min</td>
                                    <td>Max</td>
                                    <td>Value</td>
                                </th>
                                <xsl:for-each select="$describeTaskingResponse/sps:taskingDescriptor/sps:InputDescriptor">
                                    <xsl:variable name="parameterID" select="@parameterID" />
                                    <xsl:variable name="definitionNode" select="/sps:definition/sps:commonData/node()" />
                                    <xsl:variable name="constraintNode" select="$definitionNode/swe:constraint" />
                                    <tr><xsl:attribute name="id"><xsl:value-of select="concat($parameterID,'_Row')" /></xsl:attribute>
                                        <td><xsl:attribute name="id"><xsl:value-of select="concat($parameterID,'_ID')" /></xsl:attribute><xsl:value-of select="$parameterID" /></td>
                                        <td><xsl:attribute name="id"><xsl:value-of select="concat($parameterID,'_Description')" /></xsl:attribute><xsl:value-of select="gml:description" /></td>
                                        <td><xsl:attribute name="id"><xsl:value-of select="concat($parameterID,'_Use')" /></xsl:attribute><xsl:value-of select="@use" /></td>
                                        <td><xsl:attribute name="id"><xsl:value-of select="concat($parameterID,'_Type')" /></xsl:attribute><xsl:value-of select="local-name-from-QName(node-name($definitionNode))" /></td>
                                        <td><xsl:attribute name="id"><xsl:value-of select="concat($parameterID,'_Definition')" /></xsl:attribute><xsl:value-of select="$definitionNode/@definition" /></td>
                                        <td><xsl:attribute name="id"><xsl:value-of select="concat($parameterID,'_Units')" /></xsl:attribute><xsl:value-of select="$definitionNode/swe:uom/@code" /></td>
                                        <td><xsl:attribute name="id"><xsl:value-of select="concat($parameterID,'_Min')" /></xsl:attribute><xsl:value-of select="$constraintNode/swe:AllowedValues/swe:min" /></td>
                                        <td><xsl:attribute name="id"><xsl:value-of select="concat($parameterID,'_Max')" /></xsl:attribute><xsl:value-of select="$constraintNode/swe:AllowedValues/swe:max" /></td>
                                        <td><input type="text"><xsl:attribute name="id"><xsl:value-of select="concat($parameterID,'_Value')" /></xsl:attribute></input></td>
                                    </tr>
                                </xsl:for-each>
                             </table>
                          </blockquote>
                          <input type="submit" value="Submit"/>
                       </body>
                    </ctl:form>
                </xsl:variable>
                <!--TODO:  Add in parameter checking somehow?-->
                <xsl:variable name="submitRequest">
                    <Submit xmlns="http://www.opengis.net/sps" xmlns:gml="http://www.opengis.net/gml" xmlns:swe="http://www.opengis.net/swe" service="SPS" version="1.0.0">
                        <notificationTarget>
                            <notificationID><xsl:value-of select="$enterTaskingOptionsForm//input[@id='wnsUserID']" /></notificationID>
                            <notificationURL><xsl:value-of select="$enterTaskingOptionsForm//input[@id='wnsURL']" /></notificationURL>
                        </notificationTarget>
                        <sensorParam>
                            <sensorID><xsl:value-of select="$selectedSensorID" /></sensorID>
                            <parameters>
                                <xsl:for-each select="$enterTaskingOptionsForm//table/tr[contains(@id,'_Row')]">
                                    <xsl:if test="(td[contains(@id,'_Use')]='required') or (string-length(normalize-space(td[contains(@id,'_Value')]))>0)">
                                        <InputParameter><xsl:attribute name="parameterID"><xsl:value-of select="td[contains(@id,'_ID')]" /></xsl:attribute>
                                            <value>
                                                <xsl:variable name="elementName" select="td[contains(@id,'_Type')]/text()" />
                                                <xsl:variable name="elementValue" select="td[contains(@id,'_Value')]/text()" />
                                                <xsl:element name="{$elementName}"><xsl:value-of select="$elementValue" /></xsl:element>
                                            </value>
                                        </InputParameter>
                                    </xsl:if>
                                </xsl:for-each>
                            </parameters>
                        </sensorParam>
                        <timeFrame>
                            <gml:TimeInstant>
                                <gml:timePosition>
                                    <ctl:call-function name="spsFunctions:getCurrentDateTime" />
                                </gml:timePosition>
                            </gml:TimeInstant>
                        </timeFrame>
                    </Submit>
                </xsl:variable>
                <ctl:message>Submit request constructed:  <xsl:value-of select="$submitRequest" /></ctl:message>
                <!--Build a Submit request with the provided input from the previously displayed form-->
                <xsl:variable name="submitResponse">
                    <ctl:request>
                        <ctl:url>
                            <xsl:value-of select="$submitURL" />
                        </ctl:url>
                        <ctl:method>post</ctl:method>
                        <ctl:body>
                            <xsl:value-of select="$submitRequest" />
                        </ctl:body>
                        <parsers:XMLValidatingParser>
                            <parsers:schemas>
                                <parsers:schema type="url">
                                    <ctl:call-function name="spsFunctions:getSchemaLocation">
                                        <ctl:with-param name="schemaName" select="string('spsSubmitRequestResponse.xsd')" />
                                    </ctl:call-function>
                                </parsers:schema>
                                <parsers:schema type="url">
                                    <ctl:call-function name="spsFunctions:getSchemaLocation">
                                        <ctl:with-param name="schemaName" select="string('owsExceptionReport.xsd')" />
                                    </ctl:call-function>
                                </parsers:schema>
                            </parsers:schemas>
                        </parsers:XMLValidatingParser>
                    </ctl:request>
                </xsl:variable>
                <!--Get the approximate time the request was submitted.  This will be used for later tests-->
                <xsl:variable name="submitTime">
                    <ctl:call-function name="spsFunctions:getCurrentDateTime" />
                </xsl:variable>
                <ctl:message>Submit request submitted at:  <xsl:value-of select="$submitTime" /></ctl:message>
                <!--Call the other request tests using the Submit request that was constructed previously-->
                <ctl:call-test name="sps:core-SPS.Submit-RequestInvalidNotificationTarget.1">
                    <ctl:with-param name="submitURL" select="$submitURL" />
                    <ctl:with-param name="submitRequest" select="$submitRequest" />
                </ctl:call-test>
                <ctl:call-test name="sps:core-SPS.Submit-RequestSensorParamInvalidSensorID.1">
                  <ctl:with-param name="submitURL" select="$submitURL" />
                  <ctl:with-param name="submitRequest" select="$submitRequest" />
                </ctl:call-test>
                <ctl:call-test name="sps:core-SPS.Submit-RequestSensorParamInvalidParameters.1">
                  <ctl:with-param name="submitURL" select="$submitURL" />
                  <ctl:with-param name="submitRequest" select="$submitRequest" />
                </ctl:call-test>
                <ctl:call-test name="sps:core-SPS.Submit-RequestSensorParamParametersMissingRequiredParameters.1">
                  <ctl:with-param name="submitURL" select="$submitURL" />
                  <ctl:with-param name="submitRequest" select="$submitRequest" />
                </ctl:call-test>
                <ctl:call-test name="sps:core-SPS.Submit-RequestSensorParamParametersExpectedResponse.1">
                  <ctl:with-param name="submitURL" select="$submitURL" />
                  <ctl:with-param name="submitRequest" select="$submitRequest" />
                  <ctl:with-param name="submitResponse" select="$submitResponse" />
                </ctl:call-test>
                <ctl:call-test name="sps:core-SPS.Submit-RequestValidTimeFrame.1">
                  <ctl:with-param name="submitURL" select="$submitURL" />
                  <ctl:with-param name="submitRequest" select="$submitRequest" />
                </ctl:call-test>
                <!--Call the response tests using the Submit response from the user input-->
                <ctl:call-test name="sps:core-SPS.Submit-ResponseMain.1">
                    <ctl:with-param name="submitURL" select="$submitURL" />
                    <ctl:with-param name="submitRequest" select="$submitRequest" />
                    <ctl:with-param name="submitResponse" select="$submitResponse" />
                    <ctl:with-param name="submitTime" select="$submitTime" />
                </ctl:call-test>
            </xsl:otherwise>
        </xsl:choose>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.Submit-RequestInvalidNotificationTarget.1">
      <ctl:param name="submitURL" />
      <ctl:param name="submitRequest" />
      <ctl:assertion>Invalid data in the notificationTarget element of a Submit request produces a valid exception message.</ctl:assertion>
      <ctl:comment>Pass if a returned exception message is a valid exception report and has an exceptionCode value that is valid for the Submit operation; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the server handles invalid notification target information correctly.  This includes notificationID being null and notificationURL being unresolvable to a valid WNS.">ATS_URL#SPS.Submit-RequestInvalidNotificationTarget</ctl:link>
      <ctl:code>
        <!--Replace the notificationID in a valid request with an invalid notificationID-->
        <!--Replace the notificationURL in a valid request with an invalid notificationURL-->
        <!--Replace the notificationID and notificationURL in a valid request with invalid values-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.Submit-RequestSensorParamInvalidSensorID.1">
      <ctl:param name="submitURL" />
      <ctl:param name="submitRequest" />
      <ctl:assertion>The server returns a valid exception message with a value of UnknownSensorID for the exceptionCode and the unknown sensorID for the locator. </ctl:assertion>
      <ctl:comment>Pass if a returned exception message is a valid exception report and has an exceptionCode value of UnknownSensorID and a locator value listing the unknown sensorID; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the server returns a valid exception message when an invalid sensorID is provided in the request.">ATS_URL#SPS.Submit-RequestSensorParamInvalidSensorID</ctl:link>
      <ctl:code>
        <!--Replace the sensorID in a valid request with an invalid value-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.Submit-RequestSensorParamInvalidParameters.1">
      <ctl:param name="submitURL" />
      <ctl:param name="submitRequest" />
      <ctl:assertion>The server returns a valid Submit response with a status element value of rejected when invalid parameter values are supplied in the request. </ctl:assertion>
      <ctl:comment>Pass if a returned Submit response is valid and the status element has a value of rejected; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the server returns a Submit response of rejected when invalid parameter values are supplied in the request.">ATS_URL#SPS.Submit-RequestSensorParamInvalidParameters</ctl:link>
      <ctl:code>
        <!--Replace the parameterID value(s) in a valid Submit request with invalid values-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.Submit-RequestSensorParamParametersMissingRequiredParameters.1">
      <ctl:param name="submitURL" />
      <ctl:param name="submitRequest" />
      <ctl:assertion>The server returns a valid Submit response with a status element value of incomplete request when required parameters are missing from the request.</ctl:assertion>
      <ctl:comment>Pass if a returned Submit response is valid and the status element has a value of incomplete request; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the server returns a Submit response of incomplete request when required parameters are missing from the request.">ATS_URL#SPS.Submit-RequestSensorParamParametersMissingRequiredParameters</ctl:link>
      <ctl:code>
        <!--Eliminate one or more required parameters from a valid Submit request-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.Submit-RequestSensorParamParametersExpectedResponse.1">
      <ctl:param name="submitURL" />
      <ctl:param name="submitRequest" />
      <ctl:param name="submitResponse" />
      <ctl:assertion>The server returns a valid Submit response with expected values given the parameter values supplied in the request.</ctl:assertion>
      <ctl:comment>Pass if a returned Submit response is valid and the values for the parameters are expected based on the request; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the server returns an expected Submit response given the parameter values in the request.  Test various parameter combinations.">ATS_URL#SPS.Submit-RequestSensorParamParametersExpectedResponse</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.Submit-RequestValidTimeFrame.1">
      <ctl:param name="submitURL" />
      <ctl:param name="submitRequest" />
      <ctl:assertion>The server returns a valid Submit response with a status element value of rejected when an invalid time value (before the current time, etc.) is supplied in the timeFrame parameter.</ctl:assertion>
      <ctl:comment>Pass if a returned Submit response is valid and the status element has a value of "rejected"; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the server returns a Submit response of rejected when an invalid time value is supplied in the timeFrame parameter.">ATS_URL#SPS.Submit-RequestValidTimeFrame</ctl:link>
      <ctl:code>
        <!--Modify the timeFrame value to occur in the past-->
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.Submit-ResponseMain.1">
      <ctl:param name="submitURL" />
      <ctl:param name="submitRequest" />
      <ctl:param name="submitResponse" />
      <ctl:param name="submitTime" />
      <ctl:assertion>The response to a valid Submit request contains valid values for its sub-elements</ctl:assertion>
      <ctl:comment>Pass if the response is a valid SubmitRequestResponse document and the values of the sub-elements are valid</ctl:comment>
      <ctl:link title="">ATS_URL#SPS.Submit-ResponseMain</ctl:link>
      <ctl:code>
        <xsl:choose>
            <xsl:when test="not($submitResponse/*)">
                <ctl:message>The server did not return a response for the Submit request, or the response was not valid according to the SubmitRequestResponse schema</ctl:message>
                <ctl:fail />
            </xsl:when>
            <xsl:otherwise>
                <!--Validate taskID in the response-->
                <ctl:call-test name="sps:core-SPS.Submit-ResponseValidTaskID.1">
                    <ctl:with-param name="submitResponse" select="$submitResponse" />
                </ctl:call-test>
                <!--Validate estimatedToC in the response-->
                <ctl:call-test name="sps:core-SPS.Submit-ResponseValidEstimatedToC.1">
                    <ctl:with-param name="submitResponse" select="$submitResponse" />
                    <ctl:with-param name="submitTime" select="$submitTime" />
                </ctl:call-test>
                <!--Validate taskID in the response-->
                <xsl:if test="$submitResponse[sps:status='rejected, alternatives available'] or $submitResponse/sps:alternative">
                    <ctl:call-test name="sps:core-SPS.Submit-ResponseCorrectUseOfAlternative.1">
                        <ctl:with-param name="submitResponse" select="$submitResponse" />
                    </ctl:call-test>
                </xsl:if>
                <!--Validate LatestResponseTime in the response-->
                <ctl:call-test name="sps:core-SPS.Submit-ResponseValidLatestResponseTime.1">
                    <ctl:with-param name="submitResponse" select="$submitResponse" />
                    <ctl:with-param name="submitTime" select="$submitTime" />
                </ctl:call-test>
            </xsl:otherwise>
        </xsl:choose>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.Submit-ResponseValidTaskID.1">
      <ctl:param name="submitResponse" />
      <ctl:assertion>The taskID parameter of a Submit response contains a value.</ctl:assertion>
      <ctl:comment>Pass if the response is a valid Submit response and the taskID parameter of the response contains a value; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the taskID parameter of a Submit response contains a value.">ATS_URL#SPS.Submit-ResponseValidTaskID</ctl:link>
      <ctl:code>
        <xsl:if test="$submitResponse/sps:taskID">
            <xsl:if test="string-length(normalize-space())=0">
                <ctl:message>The taskID in the response for the Submit request was null.</ctl:message>
                <ctl:fail />
            </xsl:if>
        </xsl:if>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.Submit-ResponseValidEstimatedToC.1">
      <ctl:param name="submitResponse" />
      <ctl:param name="submitTime" />
      <ctl:assertion>If the estimatedToC element appears in the response, then this element contains a value that is a valid time value that occurs after the time the request was submitted.</ctl:assertion>
      <ctl:comment>Pass if the response is a valid Submit response and the estimatedToC parameter of the response contains a value that is a valid time value and occurs after the time the request was submitted; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the estimatedToC parameter of a Submit response occurs after the time the request was submitted.">ATS_URL#SPS.Submit-ResponseValidEstimatedToC</ctl:link>
      <ctl:code>
        <xsl:if test="$submitResponse/sps:estimatedToC/gml:TimeInstant/gml:timePosition">
            <xsl:variable name="estimatedToC" select="." />
            <xsl:variable name="isTimeValid">
                <ctl:call-function name="spsFunctions:checkTime">
                    <ctl:with-param name="timeToCheck" select="$estimatedToC" />
                    <ctl:with-param name="compareTime" select="$submitTime" />
                </ctl:call-function>
            </xsl:variable>
            <xsl:if test="not($isTimeValid)">
                <ctl:message>The value in the estimatedToC element (<xsl:value-of select="$estimatedToC" />) is null or does not occur after the time the Submit request was submitted (<xsl:value-of select="$submitTime" />)</ctl:message>
                <ctl:fail />
            </xsl:if>
        </xsl:if>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.Submit-ResponseCorrectUseOfAlternative.1">
      <ctl:param name="submitResponse" />
      <ctl:assertion>If the status value is rejected, alternatives available, then a valid value is provided for the alternative parameter.  If a value is provided for the alternative parameter, then the status value is rejected, alternatives available.</ctl:assertion>
      <ctl:comment>Pass if the response is a valid Submit response with a status of "rejected, alternatives available" and the alternative parameter is provided and has a value; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the alternative parameter of a Submit response is used only when the status is rejected, alternatives available.">ATS_URL#SPS.Submit-ResponseCorrectUseOfAlternative</ctl:link>
      <ctl:code>
        <xsl:variable name="isStatusRejected" select="$submitResponse//sps:SubmitRequestResponse[sps:status='rejected, alternatives available']" />
        <xsl:variable name="isAlternativeSupplied" select="$submitResponse//sps:SubmitRequestResponse/sps:alternative/*" />
        <xsl:if test="($isStatusRejected and not($isAlternativeSupplied)) or (not($isStatusRejected) and $isAlternativeSupplied)">
            <ctl:message>When the status is "rejected, alternatives available", a value should be supplied in the alternative element; when a value is supplied in the alternative element, then the status should be "rejected, alternatives available".</ctl:message>
            <ctl:fail />
        </xsl:if>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.Submit-ResponseValidLatestResponseTime.1">
      <ctl:param name="submitResponse" />
      <ctl:param name="submitTime" />
      <ctl:assertion>The LatestResponseTime value of the Submit response is a valid time value that occurs after the time the request was submitted.</ctl:assertion>
      <ctl:comment>Pass if the response is a valid Submit response with a LatestResponseTime parameter value time occuring after the time the request was submitted; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that the LatestResponseTime parameter of a Submit response occurs after the time the request was submitted.">ATS_URL#SPS.Submit-ResponseValidLatestResponseTime</ctl:link>
      <ctl:code>
        <xsl:if test="$submitResponse/sps:LatestResponseTime/gml:TimeInstant/gml:timePosition">
            <xsl:variable name="latestResponseTime" select="." />
            <xsl:variable name="isTimeValid">
                <ctl:call-function name="spsFunctions:checkTime">
                    <ctl:with-param name="timeToCheck" select="$latestResponseTime" />
                    <ctl:with-param name="compareTime" select="$submitTime" />
                </ctl:call-function>
            </xsl:variable>
            <xsl:if test="not($isTimeValid)">
                <ctl:message>The value in the LatestResponseTime element (<xsl:value-of select="$latestResponseTime" />) is null or does not occur after the time the Submit request was submitted (<xsl:value-of select="$submitTime" />)</ctl:message>
                <ctl:fail />
            </xsl:if>
        </xsl:if>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.Submit-ValidException.1">
      <ctl:param name="submitResponse" />
      <ctl:assertion>An exception message returned by the server is a valid exception message for the Submit operation.</ctl:assertion>
      <ctl:comment>Pass if the response is a valid exception message for the Submit operation; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that any exception message returned by the server is a valid exception message for the Submit operation.">ATS_URL#SPS.Submit-ValidException</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
      </ctl:code>
    </ctl:test>
    
    <!--DescribeResultAccess tests-->
    <ctl:test name="sps:core-SPS.DescribeResultAccess-RequestNullSensorID.1">
      <ctl:param name="describeResultAccessURL" />
      <ctl:assertion>A null sensorID in the request produces a valid exception message of InvalidParameterValue with sensorID listed in the locator field.</ctl:assertion>
      <ctl:comment>Pass if the response is a valid exception message with an exceptionCode value of InvalidParameterValue and sensorID listed in the locator field; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that a null sensorID in the request produces a valid exception message of InvalidParameterValue.">ATS_URL#SPS.DescribeResultAccess-RequestNullSensorID</ctl:link>
      <ctl:code>
        <!--
                    1.)  Issue a DescribeResultAccess request
                    2.)  Validate the response against the ExceptionReport schema
                    3.)  Check the values in the response
                -->
        <xsl:variable name="describeResultAccessRequestResponse">
            <ctl:call-function name="spsFunctions:describeResultAccessRequest">
                <ctl:with-param name="describeResultAccessURL" select="$describeResultAccessURL" />
                <ctl:with-param name="sensorOrTaskID" select="string('')" />
                <ctl:with-param name="type" select="sensorID" />
            </ctl:call-function>
        </xsl:variable>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeResultAccess-RequestInvalidSensorID.1">
      <ctl:param name="describeResultAccessURL" />
      <ctl:assertion>An invalid sensorID in the request produces a valid exception message of UnknownSensorID.</ctl:assertion>
      <ctl:comment>Pass if the response is a valid exception message with an exceptionCode value of UnknownSensorID and the unknown sensorID listed in the locator field; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that an invalid sensorID in the request produces a valid exception message of UnknownSensorID.">ATS_URL#SPS.DescribeResultAccess-RequestInvalidSensorID</ctl:link>
      <ctl:code>
        <xsl:variable name="describeResultAccessRequestResponse">
            <ctl:call-function name="spsFunctions:describeResultAccessRequest">
                <ctl:with-param name="describeResultAccessURL" select="$describeResultAccessURL" />
                <ctl:with-param name="sensorOrTaskID" select="lksadjflkadsjfkljdsafkweuoiuoiweruoiweklsajflksdajflkdsafjlksdajflksadfjlkdsfajkladfsjlkdasfjlkasdfj" />
                <ctl:with-param name="type" select="sensorID" />
            </ctl:call-function>
        </xsl:variable>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeResultAccess-RequestNullTaskID.1">
      <ctl:param name="describeResultAccessURL" />
      <ctl:assertion>A null taskID in the request produces a valid exception message of InvalidParameterValue.</ctl:assertion>
      <ctl:comment>Pass if the response is a valid exception message with an exceptionCode value of InvalidParameterValue and taskID listed in the locator field; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that a null taskID in the request produces a valid exception message of InvalidParameterValue.">ATS_URL#SPS.DescribeResultAccess-RequestNullTaskID</ctl:link>
      <ctl:code>
        <xsl:variable name="describeResultAccessRequestResponse">
            <ctl:call-function name="spsFunctions:describeResultAccessRequest">
                <ctl:with-param name="describeResultAccessURL" select="$describeResultAccessURL" />
                <ctl:with-param name="sensorOrTaskID" select="string('')" />
                <ctl:with-param name="type" select="taskID" />
            </ctl:call-function>
        </xsl:variable>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeResultAccess-RequestInvalidTaskID.1">
      <ctl:param name="describeResultAccessURL" />
      <ctl:assertion>An invalid taskID in the request produces a valid exception message of TaskIDExpired.</ctl:assertion>
      <ctl:comment>Pass if the response is a valid exception message with an exceptionCode value TaskIDExpired; fail otherwise.</ctl:comment>
      <ctl:link title="Verify that an invalid taskID in the request produces a valid exception message of TaskIDExpired.">ATS_URL#SPS.DescribeResultAccess-RequestInvalidTaskID</ctl:link>
      <ctl:code>
        <xsl:variable name="taskID" select="kaskjdfkltiowutoiwut098239825uuewioejriowerioweuqroiuwerqiouwerqiouerqiowwqoieriowqeriouioqweroiurewq" />
        <xsl:variable name="describeResultAccessRequestResponse">
            <ctl:call-function name="spsFunctions:describeResultAccessRequest">
                <ctl:with-param name="describeResultAccessURL" select="$describeResultAccessURL" />
                <ctl:with-param name="sensorOrTaskID" select="$taskID" />
                <ctl:with-param name="type" select="taskID" />
            </ctl:call-function>
        </xsl:variable>
        <xsl:choose>
            <xsl:when test="not($describeResultAccessRequestResponse/*)">
                <ctl:message>The response to a DescribeResultAccess request with taskID=<xsl:value-of select="$taskID" /> was expected to be an exception report.  Either the server did not return a response or the response was not valid according to the associated schema for an exception report.</ctl:message>
                <ctl:fail />
            </xsl:when>
            <xsl:otherwise>
                <xsl:if test="$describeResultAccessRequestResponse/ows:ExceptionReport/ows:Exception">
                    <xsl:if test="not(@exceptionCode='TaskIDExpired')">
                        <ctl:message>An exceptionCode of TaskIDExpired was expected in the response.  "<xsl:value-of select="@exceptionCode" />" was provided instead.</ctl:message>
                        <ctl:fail />
                    </xsl:if>
                    <xsl:if test="@locator">
                        <ctl:message>The locator parameter was expected to be omitted.</ctl:message>
                        <ctl:fail />
                    </xsl:if>
                </xsl:if>
            </xsl:otherwise>
        </xsl:choose>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeResultAccess-ResponseMain.1">
      <ctl:param name="getCapabilitiesResponse" />
      <ctl:param name="describeResultAccessURL" />
      <ctl:assertion>A valid sensorID in the request does not produce a DataNotAvailable response.</ctl:assertion>
      <ctl:comment>Fail if the response is a DataNotAvailable response when the request contained a valid sensorID; pass otherwise.</ctl:comment>
      <ctl:link title="Verify that a valid request containing a sensorID parameter produces a valid response other than DataNotAvailable.">ATS_URL#SPS.DescribeResultAccess-ResponseSensorIDValidResponse</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--Call each of the DescribeResultAccess sub-tests using SensorID values from the Capabilities document-->
        <xsl:for-each select="$getCapabilitiesResponse/sps:Contents/sps:SensorOfferings//sps:SensorOffering/sps:SensorID">
            <xsl:variable name="describeResultAccessResponse">
                <ctl:call-function name="spsFunctions:describeResultAccessRequest">
                    <ctl:with-param name="describeResultAccessURL" select="$describeResultAccessURL" />
                    <ctl:with-param name="sensorOrTaskID" select="." />
                    <ctl:with-param name="type" select="sensorID" />
                </ctl:call-function>
            </xsl:variable>
            <!--Check that the response is not a DataNotAvailable response-->
            <ctl:call-test name="sps:core-SPS.DescribeResultAccess-ResponseSensorIDValidResponse.1">
                <ctl:with-param name="requestedSensorID" select="." />
                <ctl:with-param name="describeResultAccessResponse" select="$describeResultAccessResponse" />
            </ctl:call-test>
            <!--Check that the ServiceType is valid-->
            <ctl:call-test name="sps:core-SPS.DescribeResultAccess-ResponseValidServiceType.1">
                <ctl:with-param name="requestedSensorID" select="." />
                <ctl:with-param name="describeResultAccessResponse" select="$describeResultAccessResponse" />
            </ctl:call-test>
            <!--Check that the ServiceURL is valid-->
            <ctl:call-test name="sps:core-SPS.DescribeResultAccess-ResponseValidServiceURL.1">
                <ctl:with-param name="requestedSensorID" select="." />
                <ctl:with-param name="describeResultAccessResponse" select="$describeResultAccessResponse" />
            </ctl:call-test>
        </xsl:for-each>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeResultAccess-ResponseSensorIDValidResponse.1">
      <ctl:param name="requestedSensorID" />
      <ctl:param name="describeResultAccessResponse" />
      <ctl:assertion>A valid sensorID in the request does not produce a DataNotAvailable response.</ctl:assertion>
      <ctl:comment>Fail if the response is a DataNotAvailable response when the request contained a valid sensorID; pass otherwise.</ctl:comment>
      <ctl:link title="Verify that a valid request containing a sensorID parameter produces a valid response other than DataNotAvailable.">ATS_URL#SPS.DescribeResultAccess-ResponseSensorIDValidResponse</ctl:link>
      <ctl:code>
        <!--Check for a DataNotAvailable response-->
        <xsl:if test="$describeResultAccessResponse//sps:DataNotAvailable">
            <ctl:message>A DescribeResultAccess request for <xsl:value-of select="$requestedSensorID" /> produced a DataNotAvailable response.</ctl:message>
            <ctl:fail />
        </xsl:if>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeResultAccess-ResponseValidServiceType.1">
      <ctl:param name="requestedSensorID" />
      <ctl:param name="describeResultAccessResponse" />
      <ctl:assertion>The ServiceType value in the response contains a value.</ctl:assertion>
      <ctl:comment>Pass if the ServiceType in the response contains a value; fail otherwise</ctl:comment>
      <ctl:link title="Verify that the ServiceType in the response contains a value.">ATS_URL#SPS.DescribeResultAccess-ResponseValidServiceType</ctl:link>
      <ctl:code>
        <!--Check to see if the ServiceType element contains a value-->
        <xsl:variable name="serviceType" select="$describeResultAccessResponse/sps:ServiceType" />
        <xsl:if test="string-length($serviceType)=0">
            <ctl:message>The ServiceType value in a DescribeResultAccess response for sensorID <xsl:value-of select="$requestedSensorID" /> is null.</ctl:message>
            <ctl:fail />
        </xsl:if>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeResultAccess-ResponseValidServiceURL.1">
      <ctl:param name="requestedSensorID" />
      <ctl:param name="describeResultAccessResponse" />
      <ctl:assertion>The ServiceURL value in the response contains a value and is resolvable.</ctl:assertion>
      <ctl:comment>Pass if the ServiceType in the response contains a value and is resolvable; fail otherwise</ctl:comment>
      <ctl:link title="Verify that the ServiceURL in the response contains a value and that value is resolvable.">ATS_URL#SPS.DescribeResultAccess-ResponseValidServiceURL</ctl:link>
      <ctl:code>
        <!--Check to see if the ServiceURL is valid-->
        <xsl:variable name="serviceURL" select="$describeResultAccessResponse/sps:ServiceURL" />
        <xsl:if test="string-length($serviceURL)=0">
            <ctl:message>The ServiceURL value in a DescribeResultAccess response for sensorID <xsl:value-of select="$requestedSensorID" /> is null.</ctl:message>
            <ctl:fail />
        </xsl:if>
        <xsl:if test="matches($serviceURL,'(^|[ \t\r\n])((ftp|http|https|gopher|mailto|news|nntp|telnet|wais|file|prospero|aim|webcal):(([A-Za-z0-9$_.+!*(),;/?:@&amp;~=-])|%[A-Fa-f0-9]{2}){2,}(#([a-zA-Z0-9][a-zA-Z0-9$_.+!*(),;/?:@&amp;~=%-]*))?([A-Za-z0-9$_+!*();/?:~-]))','i')"><!--(^|[ \t\r\n])((ftp|http|https|gopher|mailto|news|nntp|telnet|wais|file|prospero|aim|webcal):(([A-Za-z0-9$_.+!*(),;/?:@&~=-])|%[A-Fa-f0-9]{2}){2,}(#([a-zA-Z0-9][a-zA-Z0-9$_.+!*(),;/?:@&~=%-]*))?([A-Za-z0-9$_+!*();/?:~-]))-->
            <ctl:message>The ServiceURL value in a DescribeResultAccess response for sensorID <xsl:value-of select="$requestedSensorID" /> is not a valid URL</ctl:message>
            <ctl:fail />
        </xsl:if>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeResultAccess-ResponseValidDataNotAvailable.1">
      <ctl:param name="describeResultAccessURL" />
      <ctl:assertion>A DataNotAvailable response is valid and contains values for each of the parameters.</ctl:assertion>
      <ctl:comment>Pass if the DataNotAvailable response is valid and contains a value for each of the parameters; fail otherwise</ctl:comment>
      <ctl:link title="Verify that a DataNotAvailable response is valid and contains values for each of the parameters.">ATS_URL#SPS.DescribeResultAccess-ResponseValidDataNotAvailable</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
        <!--
                    1.)  DescribeResultAccess request with a previously generated taskID or with an empty string for the taskID.
                    2.)  Validate response according to the DescribeResultAccessRequestResponse schema
                    3.)  Iterate through the key parameters of the DescribeResultAccess response to ensure that each parameter/element contains a value
                -->
        <xsl:variable name="taskID" select="string('')" />
        <xsl:variable name="describeResultAccessResponse">
            <ctl:call-function name="spsFunctions:describeResultAccessRequest">
                <ctl:with-param name="describeResultAccessURL" select="$describeResultAccessURL" />
                <ctl:with-param name="sensorOrTaskID" select="$taskID" />
                <ctl:with-param name="type" select="taskID" />
            </ctl:call-function>
        </xsl:variable>
        <!--Validate-->
        <xsl:choose>
            <xsl:when test="not($describeResultAccessResponse/*)">
                <ctl:message>The server did not return a response from a DescribeResultAccess request with a taskID of <xsl:value-of select="$taskID" />, or the response was not valid according to the DescribeResultAccessRequestResponse schema.</ctl:message>
            </xsl:when>
            <xsl:otherwise>
                <xsl:variable name="dataNotAvailableElement" select="$describeResultAccessResponse/sps:DataNotAvailable" />
                <xsl:choose>
                    <xsl:when test="$dataNotAvailableElement">
                        <xsl:variable name="reason" select="normalize-space($dataNotAvailableElement/sps:reason)" />
                        <xsl:if test="string-length($reason)=0">
                            <ctl:message>The DescribeResultAccess request for taskID <xsl:value-of select="$taskID" /> produced a DataNotAvailable response with an empty string for the reason element.</ctl:message>
                            <ctl:fail />
                        </xsl:if>
                    </xsl:when>
                <xsl:otherwise>
                    <ctl:message>The DescribeResultAccess response for taskID <xsl:value-of select="$taskID" /> was expected to be a DataNotAvailable response.  "<xsl:value-of select="$describeResultAccessResponse/*" />" was returned instead.</ctl:message>
                    <ctl:fail />
                </xsl:otherwise>
                </xsl:choose>
            </xsl:otherwise>
        </xsl:choose>
      </ctl:code>
    </ctl:test>
    <ctl:test name="sps:core-SPS.DescribeResultAccess-ValidException.1">
      <ctl:param name="describeResultAccessDocument" />
      <ctl:assertion>An exception message returned by the server is a valid exception message for the DescribeResultAccess operation.</ctl:assertion>
      <ctl:comment>Pass if the response is a valid exception message for the DescribeResultAccess operation; fail otherwise</ctl:comment>
      <ctl:link title="Verify that any exception message returned by the server is a valid exception message for the DescribeResultAccess operation.">ATS_URL#SPS.DescribeResultAccess-ValidException</ctl:link>
      <ctl:code>
        <!--PUT TEST CODE HERE-->
      </ctl:code>
    </ctl:test>
  </ctl:package>
</ctl:package>